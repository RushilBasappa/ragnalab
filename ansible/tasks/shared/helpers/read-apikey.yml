---
# READ API KEY (read from already-running *arr app's config volume)
# Required: arr_name
# Sets: {{ arr_name }}_api_key, arr_api_key
- name: "[{{ arr_name | default('?') }}] Get config volume mountpoint"
  community.docker.docker_volume_info:
    name: "{{ arr_name }}_data"
  register: _arr_volume

- name: "[{{ arr_name | default('?') }}] Read config.xml"
  ansible.builtin.slurp:
    src: "{{ _arr_volume.volume.Mountpoint }}/config.xml"
  register: _arr_config_raw
  become: true

- name: "[{{ arr_name | default('?') }}] Set API key facts"
  ansible.builtin.set_fact:
    "{{ arr_name }}_api_key": "{{ (_arr_config_raw.content | b64decode) | regex_search('<ApiKey>(.*)</ApiKey>', '\\1') | first }}"
    arr_api_key: "{{ (_arr_config_raw.content | b64decode) | regex_search('<ApiKey>(.*)</ApiKey>', '\\1') | first }}"

- name: "[{{ arr_name | default('?') }}] API key"
  ansible.builtin.debug:
    msg: "{{ arr_name }} API key: {{ arr_api_key }}"
