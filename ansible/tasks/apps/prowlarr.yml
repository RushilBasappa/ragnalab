---
# Prowlarr

- name: Create volumes
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: create-volumes
    volumes: [prowlarr_config]

- name: Extract Prowlarr API key
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: extract-apikey
    arr_name: prowlarr
    arr_port: 9696

- name: Patch Prowlarr authentication
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: patch-auth
    arr_name: prowlarr
    arr_port: 9696

# Read Sonarr and Radarr API keys for app integrations
- name: Read Sonarr API key
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: read-apikey
    arr_name: sonarr

- name: Read Radarr API key
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: read-apikey
    arr_name: radarr

# Prowlarr-specific: add Sonarr and Radarr as applications
- name: Check existing Prowlarr applications
  ansible.builtin.command: >
    docker exec prowlarr curl -sf
    -H 'X-Api-Key: {{ prowlarr_api_key }}'
    http://localhost:9696/api/v1/applications
  register: prowlarr_apps
  changed_when: false

- name: Add Sonarr to Prowlarr
  ansible.builtin.command: >
    docker exec prowlarr curl -sf -X POST
    -H 'Content-Type: application/json'
    -H 'X-Api-Key: {{ prowlarr_api_key }}'
    -d '{"name":"Sonarr","implementation":"Sonarr","configContract":"SonarrSettings","syncLevel":"fullSync","fields":[{"name":"prowlarrUrl","value":"http://prowlarr:9696"},{"name":"baseUrl","value":"http://sonarr:8989"},{"name":"apiKey","value":"{{ sonarr_api_key }}"}]}'
    http://localhost:9696/api/v1/applications
  when: "'Sonarr' not in prowlarr_apps.stdout"
  changed_when: true

- name: Add Radarr to Prowlarr
  ansible.builtin.command: >
    docker exec prowlarr curl -sf -X POST
    -H 'Content-Type: application/json'
    -H 'X-Api-Key: {{ prowlarr_api_key }}'
    -d '{"name":"Radarr","implementation":"Radarr","configContract":"RadarrSettings","syncLevel":"fullSync","fields":[{"name":"prowlarrUrl","value":"http://prowlarr:9696"},{"name":"baseUrl","value":"http://radarr:7878"},{"name":"apiKey","value":"{{ radarr_api_key }}"}]}'
    http://localhost:9696/api/v1/applications
  when: "'Radarr' not in prowlarr_apps.stdout"
  changed_when: true
