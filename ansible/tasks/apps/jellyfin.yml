---
# Jellyfin

- name: Create volumes
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: create-volumes
    volumes: [jellyfin_data]

- name: Start Jellyfin
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: start
    services: [jellyfin]

- name: Get jellyfin_data volume path
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: get-volume-path
    volume_name: jellyfin_data

- name: Wait for Jellyfin system config to exist
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: wait-for-file
    file_path: "{{ _volume_path }}/config/system.xml"

- name: Read system config
  ansible.builtin.slurp:
    src: "{{ _volume_path }}/config/system.xml"
  register: jellyfin_system_xml
  become: true

- name: Check if setup wizard is pending
  ansible.builtin.set_fact:
    jellyfin_wizard_pending: "{{ 'IsStartupWizardCompleted>false<' in (jellyfin_system_xml.content | b64decode) }}"

- name: Read Jellyfin credentials from env
  ansible.builtin.set_fact:
    jellyfin_user: "{{ lookup('ansible.builtin.ini', 'JELLYFIN_ADMIN_USER', type='properties', file=env_file) }}"
    jellyfin_pass: "{{ lookup('ansible.builtin.ini', 'JELLYFIN_ADMIN_PASSWORD', type='properties', file=env_file) }}"
  when: jellyfin_wizard_pending

- name: Wait for Jellyfin API to be ready
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: wait-ready
    container_name: jellyfin
    check_port: 8096
    health_path: Startup/Configuration
  when: jellyfin_wizard_pending

- name: Set startup configuration
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"UICulture":"en-US","MetadataCountryCode":"US","PreferredMetadataLanguage":"en"}'
    http://localhost:8096/Startup/Configuration
  when: jellyfin_wizard_pending
  changed_when: true

- name: Wait for default user to be created
  ansible.builtin.command: >
    docker exec jellyfin curl -sf http://localhost:8096/Startup/User
  register: _jf_startup_user
  until: _jf_startup_user.rc == 0 and (_jf_startup_user.stdout | from_json).Name | default('') | length > 0
  retries: 15
  delay: 2
  changed_when: false
  when: jellyfin_wizard_pending

- name: Create admin user
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"Name":"{{ jellyfin_user }}","Password":"{{ jellyfin_pass }}"}'
    http://localhost:8096/Startup/User
  when: jellyfin_wizard_pending
  changed_when: true

- name: Add Movies library
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"LibraryOptions":{}}'
    "http://localhost:8096/Library/VirtualFolders?collectionType=movies&refreshLibrary=false&name=Movies"
  when: jellyfin_wizard_pending
  changed_when: true

- name: Add Movies library path
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"Name":"Movies","Path":"/data/media/movies"}'
    http://localhost:8096/Library/VirtualFolders/Paths
  when: jellyfin_wizard_pending
  changed_when: true

- name: Add TV Shows library
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"LibraryOptions":{}}'
    "http://localhost:8096/Library/VirtualFolders?collectionType=tvshows&refreshLibrary=false&name=TV%20Shows"
  when: jellyfin_wizard_pending
  changed_when: true

- name: Add TV Shows library path
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"Name":"TV Shows","Path":"/data/media/tv"}'
    http://localhost:8096/Library/VirtualFolders/Paths
  when: jellyfin_wizard_pending
  changed_when: true

- name: Configure remote access
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    -H 'Content-Type: application/json'
    -d '{"EnableRemoteAccess":true,"EnableAutomaticPortMapping":false}'
    http://localhost:8096/Startup/RemoteAccess
  when: jellyfin_wizard_pending
  changed_when: true

- name: Complete setup wizard
  ansible.builtin.command: >
    docker exec jellyfin curl -sf -X POST
    http://localhost:8096/Startup/Complete
  when: jellyfin_wizard_pending
  changed_when: true
