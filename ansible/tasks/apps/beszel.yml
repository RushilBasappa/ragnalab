---
# Beszel Hub + Agent

- name: Create volumes
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: create-volumes
    volumes: [beszel_data]

- name: Start Beszel hub
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: start
    services: [beszel]

- name: Get Beszel data volume path
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: get-volume-path
    volume_name: beszel_data

- name: Wait for Beszel key to be generated
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: wait-for-file
    file_path: "{{ _volume_path }}/id_ed25519"

- name: Derive agent public key from hub private key
  ansible.builtin.command: ssh-keygen -y -f {{ _volume_path }}/id_ed25519
  register: beszel_pubkey
  changed_when: false
  become: true

- name: Write agent key to .env
  ansible.builtin.lineinfile:
    path: "{{ env_file }}"
    regexp: "^BESZEL_AGENT_KEY="
    line: "BESZEL_AGENT_KEY={{ beszel_pubkey.stdout }}"

# --- Create superuser for API access (Homepage widget) ---

- name: Read Beszel credentials from .env
  ansible.builtin.set_fact:
    beszel_email: "{{ lookup('ini', 'BESZEL_USER', type='properties', file=env_file) }}"
    beszel_pass: "{{ lookup('ini', 'BESZEL_PASSWORD', type='properties', file=env_file) }}"

- name: Generate Beszel password if not set
  ansible.builtin.set_fact:
    beszel_pass: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  when: beszel_pass == ''

- name: Write Beszel password to .env
  ansible.builtin.lineinfile:
    path: "{{ env_file }}"
    regexp: "^BESZEL_PASSWORD="
    line: "BESZEL_PASSWORD={{ beszel_pass }}"
  when: beszel_pass != ''

- name: Create Beszel superuser for API access
  ansible.builtin.command: >
    docker exec beszel /beszel superuser upsert {{ beszel_email }} {{ beszel_pass }}
  changed_when: true

- name: Start Beszel agent
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: start
    services: [beszel-agent]

# --- Auto-register system via API (trusted header auth) ---

- name: Get Beszel container IP
  ansible.builtin.command: >
    docker inspect beszel --format
    {%- raw %} '{{range .NetworkSettings.Networks}}{{.IPAddress}} {{end}}' {% endraw %}
  register: beszel_ips
  changed_when: false

- name: Set Beszel API URL
  ansible.builtin.set_fact:
    beszel_api: "http://{{ beszel_ips.stdout.split() | first }}:8090"

- name: Wait for Beszel API
  ansible.builtin.uri:
    url: "{{ beszel_api }}/api/health"
  register: _beszel_health
  until: _beszel_health.status == 200
  retries: 30
  delay: 5

- name: Authenticate with Beszel API
  ansible.builtin.uri:
    url: "{{ beszel_api }}/api/collections/_superusers/auth-with-password"
    method: POST
    body_format: json
    body:
      identity: "{{ beszel_email }}"
      password: "{{ beszel_pass }}"
    status_code: 200
  register: beszel_auth

- name: Check if Beszel user exists
  ansible.builtin.uri:
    url: "{{ beszel_api }}/api/collections/users/records?filter=(email='{{ beszel_email }}')"
    headers:
      Authorization: "Bearer {{ beszel_auth.json.token }}"
  register: beszel_users

- name: Create Beszel user
  ansible.builtin.uri:
    url: "{{ beszel_api }}/api/collections/users/records"
    method: POST
    body_format: json
    headers:
      Authorization: "Bearer {{ beszel_auth.json.token }}"
    body:
      email: "{{ beszel_email }}"
      password: "{{ beszel_pass }}"
      passwordConfirm: "{{ beszel_pass }}"
      role: admin
    status_code: 200
  register: beszel_user_created
  when: beszel_users.json.totalItems == 0

- name: Set Beszel user ID (new user)
  ansible.builtin.set_fact:
    beszel_user_id: "{{ beszel_user_created.json.id }}"
  when: beszel_users.json.totalItems == 0

- name: Set Beszel user ID (existing user)
  ansible.builtin.set_fact:
    beszel_user_id: "{{ beszel_users.json['items'][0].id }}"
  when: beszel_users.json.totalItems != 0

- name: Check if ragnalab system exists
  ansible.builtin.uri:
    url: "{{ beszel_api }}/api/collections/systems/records?filter=(name='ragnalab')"
    headers:
      Authorization: "Bearer {{ beszel_auth.json.token }}"
  register: beszel_systems

- name: Register ragnalab system
  ansible.builtin.uri:
    url: "{{ beszel_api }}/api/collections/systems/records"
    method: POST
    body_format: json
    headers:
      Authorization: "Bearer {{ beszel_auth.json.token }}"
    body:
      name: ragnalab
      host: host.docker.internal
      port: 45876
      users: "{{ beszel_user_id }}"
    status_code: 200
  when: beszel_systems.json.totalItems == 0

- name: Beszel post-deploy
  ansible.builtin.debug:
    msg: "Beszel hub + agent deployed. Dashboard at https://beszel.{{ domain }}"
