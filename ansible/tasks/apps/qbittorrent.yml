---
# Gluetun VPN + qBittorrent

- name: Create volumes
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: create-volumes
    volumes: [gluetun_data, qbittorrent_config, media_data]

- name: Start Gluetun + qBittorrent
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: start
    services: [gluetun, qbittorrent]

- name: Wait for Gluetun to be healthy
  ansible.builtin.command: docker inspect --format '{{ '{{' }}.State.Health.Status{{ '}}' }}' gluetun
  register: gluetun_health
  until: gluetun_health.stdout == "healthy"
  retries: 30
  delay: 5
  changed_when: false

- name: Get qBittorrent config path
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: get-volume-path
    volume_name: qbittorrent_config

- name: Set config path
  ansible.builtin.set_fact:
    qbit_conf: "{{ _volume_path }}/qBittorrent/qBittorrent.conf"

- name: Wait for qBittorrent config to exist
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: wait-for-file
    file_path: "{{ qbit_conf }}"

- name: Stop qBittorrent before patching config
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: stop
    services: [qbittorrent]

- name: Patch qBittorrent config
  community.general.ini_file:
    path: "{{ qbit_conf }}"
    section: "{{ item.section }}"
    option: "{{ item.key }}"
    value: "{{ item.value }}"
    no_extra_spaces: true
  loop:
    - { section: Preferences, key: 'WebUI\AuthSubnetWhitelistEnabled', value: 'true' }
    - { section: Preferences, key: 'WebUI\AuthSubnetWhitelist', value: '0.0.0.0/0' }
    - { section: Preferences, key: 'WebUI\LocalHostAuth', value: 'false' }
    - { section: BitTorrent, key: 'Session\DefaultSavePath', value: '/data/torrents/' }
    - { section: BitTorrent, key: 'Session\TempPath', value: '/data/torrents/incomplete/' }
    - { section: Preferences, key: 'Downloads\SavePath', value: '/data/torrents/' }
    - { section: Preferences, key: 'Downloads\TempPath', value: '/data/torrents/incomplete/' }
    - { section: BitTorrent, key: 'Session\Interface', value: 'tun0' }
    - { section: BitTorrent, key: 'Session\InterfaceAddress', value: '' }
    - { section: BitTorrent, key: 'Session\InterfaceName', value: 'tun0' }
  become: true

- name: Create media directory structure
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: get-volume-path
    volume_name: media_data

- name: Ensure media directories exist
  ansible.builtin.file:
    path: "{{ _volume_path }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  loop:
    - torrents
    - torrents/incomplete
    - torrents/movies
    - torrents/tv
    - media/movies
    - media/tv
  become: true

- name: Start qBittorrent with patched config
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    action: start
    services: [qbittorrent]

- name: Wait for Gluetun port forwarding
  ansible.builtin.command: >
    docker exec gluetun wget -qO- http://127.0.0.1:8000/v1/openvpn/portforwarded
  register: port_result
  until: (port_result.stdout | from_json).port | int > 0
  retries: 30
  delay: 5
  changed_when: false

- name: Parse forwarded port
  ansible.builtin.set_fact:
    vpn_port: "{{ (port_result.stdout | from_json).port }}"

- name: Set qBittorrent listening port and interface
  ansible.builtin.command: >
    docker exec qbittorrent curl -sf -X POST
    http://localhost:8080/api/v2/app/setPreferences
    -d 'json={"listen_port":{{ vpn_port }},"current_network_interface":"tun0","current_interface_address":"10.2.0.2"}'
  changed_when: true

- name: Set seeding limit (pause after 1 minute)
  ansible.builtin.command: >
    docker exec qbittorrent curl -sf -X POST
    http://localhost:8080/api/v2/app/setPreferences
    -d 'json={"max_seeding_time_enabled":true,"max_seeding_time":1,"max_ratio_act":0}'
  changed_when: true

- name: Verify connection status
  ansible.builtin.debug:
    msg: "VPN port {{ vpn_port }} forwarded and set in qBittorrent"
