---
# Bazarr

- name: Create volumes
  community.docker.docker_volume:
    name: "{{ item }}"
  loop:
    - bazarr_config
    - media_data

- name: Start Bazarr
  community.docker.docker_compose_v2:
    project_src: "{{ playbook_dir }}/../compose"
    services:
      - bazarr
    state: present

- name: Wait for Bazarr to be ready
  ansible.builtin.command: docker exec bazarr curl -sf http://localhost:6767/ping
  register: result
  until: result.rc == 0
  retries: 30
  delay: 5
  changed_when: false

- name: Get bazarr_config volume mountpoint
  community.docker.docker_volume_info:
    name: bazarr_config
  register: bazarr_volume

- name: Set config path
  ansible.builtin.set_fact:
    bazarr_conf: "{{ bazarr_volume.volume.Mountpoint }}/config/config.yaml"

- name: Read Sonarr API key
  ansible.builtin.slurp:
    src: /var/lib/docker/volumes/sonarr_config/_data/config.xml
  register: sonarr_config_raw
  become: true

- name: Read Radarr API key
  ansible.builtin.slurp:
    src: /var/lib/docker/volumes/radarr_config/_data/config.xml
  register: radarr_config_raw
  become: true

- name: Set API keys
  ansible.builtin.set_fact:
    sonarr_api_key: "{{ (sonarr_config_raw.content | b64decode) | regex_search('<ApiKey>(.*)</ApiKey>', '\\1') | first }}"
    radarr_api_key: "{{ (radarr_config_raw.content | b64decode) | regex_search('<ApiKey>(.*)</ApiKey>', '\\1') | first }}"

- name: Stop Bazarr before patching config
  community.docker.docker_compose_v2:
    project_src: "{{ playbook_dir }}/../compose"
    services:
      - bazarr
    state: stopped

- name: Read Bazarr config
  ansible.builtin.slurp:
    src: "{{ bazarr_conf }}"
  register: bazarr_config_raw
  become: true

- name: Patch Bazarr config
  ansible.builtin.copy:
    content: "{{ bazarr_config_raw.content | b64decode | from_yaml | combine(overrides, recursive=True) | to_nice_yaml(indent=2) }}"
    dest: "{{ bazarr_conf }}"
    owner: "1000"
    group: "1000"
    mode: "0644"
  vars:
    overrides:
      auth:
        type: null
      general:
        use_sonarr: true
        use_radarr: true
      sonarr:
        apikey: "{{ sonarr_api_key }}"
        ip: sonarr
        port: 8989
      radarr:
        apikey: "{{ radarr_api_key }}"
        ip: radarr
        port: 7878
  become: true

- name: Start Bazarr with patched config
  community.docker.docker_compose_v2:
    project_src: "{{ playbook_dir }}/../compose"
    services:
      - bazarr
    state: present

- name: Wait for Bazarr to be ready after config patch
  ansible.builtin.command: docker exec bazarr curl -sf http://localhost:6767/ping
  register: result
  until: result.rc == 0
  retries: 30
  delay: 5
  changed_when: false

- name: Enable English language and create profile
  ansible.builtin.command:
    cmd: >
      docker exec bazarr python3 -c "
      import sqlite3, json;
      conn = sqlite3.connect('/config/db/bazarr.db');
      c = conn.cursor();
      changed = False;
      c.execute(\"SELECT enabled FROM table_settings_languages WHERE code3='eng'\");
      if c.fetchone()[0] != 1:
          c.execute(\"UPDATE table_settings_languages SET enabled=1 WHERE code3='eng'\");
          changed = True;
      c.execute('SELECT profileId FROM table_languages_profiles WHERE name=\"English\"');
      if not c.fetchone():
          items = json.dumps([{'id':1,'language':'en','audio_exclude':'False','hi':'False','forced':'False'}]);
          c.execute('INSERT INTO table_languages_profiles (name, items, cutoff) VALUES (?,?,?)', ('English', items, None));
          changed = True;
      conn.commit();
      print('changed' if changed else 'ok')
      "
  register: bazarr_lang
  changed_when: "'changed' in bazarr_lang.stdout"

- name: Restart Bazarr to pick up language profile
  community.docker.docker_compose_v2:
    project_src: "{{ playbook_dir }}/../compose"
    services:
      - bazarr
    state: restarted
  when: bazarr_lang.changed
