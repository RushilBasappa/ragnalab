---
# Bazarr

- name: Create volumes
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: create-volumes
    volumes: [bazarr_data, media_data]

- name: Start Bazarr
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: start
    services: [bazarr]

- name: Wait for Bazarr to be ready
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: wait-ready
    container_name: bazarr
    check_port: 6767

- name: Get bazarr_data volume path
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: get-volume-path
    volume_name: bazarr_data

- name: Set config path
  ansible.builtin.set_fact:
    bazarr_conf: "{{ _volume_path }}/config/config.yaml"

# Read Sonarr and Radarr API keys
- name: Read Sonarr API key
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: read-apikey
    arr_name: sonarr

- name: Read Radarr API key
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: read-apikey
    arr_name: radarr

# Patch Bazarr config
- name: Stop Bazarr before patching config
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: stop
    services: [bazarr]

- name: Read Bazarr config
  ansible.builtin.slurp:
    src: "{{ bazarr_conf }}"
  register: bazarr_data_raw
  become: true

- name: Patch Bazarr config
  ansible.builtin.copy:
    content: "{{ bazarr_data_raw.content | b64decode | from_yaml | combine(overrides, recursive=True) | to_nice_yaml(indent=2) }}"
    dest: "{{ bazarr_conf }}"
    owner: "1000"
    group: "1000"
    mode: "0644"
  vars:
    overrides:
      auth:
        type: null
      general:
        use_sonarr: true
        use_radarr: true
      sonarr:
        apikey: "{{ sonarr_api_key }}"
        ip: sonarr
        port: 8989
      radarr:
        apikey: "{{ radarr_api_key }}"
        ip: radarr
        port: 7878
  become: true

- name: Start Bazarr with patched config
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: start
    services: [bazarr]

- name: Wait for Bazarr to be ready after config patch
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: wait-ready
    container_name: bazarr
    check_port: 6767

- name: Enable English language and create profile
  ansible.builtin.command:
    argv:
      - docker
      - exec
      - bazarr
      - python3
      - -c
      - |
        import sqlite3, json
        conn = sqlite3.connect('/config/db/bazarr.db')
        c = conn.cursor()
        changed = False
        c.execute("SELECT enabled FROM table_settings_languages WHERE code3='eng'")
        if c.fetchone()[0] != 1:
            c.execute("UPDATE table_settings_languages SET enabled=1 WHERE code3='eng'")
            changed = True
        c.execute('SELECT profileId FROM table_languages_profiles WHERE name="English"')
        if not c.fetchone():
            items = json.dumps([{"id": 1, "language": "en", "audio_exclude": "False", "hi": "False", "forced": "False"}])
            c.execute("INSERT INTO table_languages_profiles (name, items, cutoff) VALUES (?,?,?)", ("English", items, None))
            changed = True
        conn.commit()
        print("changed" if changed else "ok")
  register: bazarr_lang
  changed_when: "'changed' in bazarr_lang.stdout"

- name: Restart Bazarr to pick up language profile
  ansible.builtin.include_tasks: ../shared/helpers.yml
  vars:
    helper: restart
    services: [bazarr]
  when: bazarr_lang.changed
