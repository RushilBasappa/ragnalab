---
# Tailscale VPN setup

- name: Add Tailscale GPG key
  ansible.builtin.apt_key:
    url: https://pkgs.tailscale.com/stable/debian/{{ ansible_distribution_release }}.noarmor.gpg
    state: present
  become: true

- name: Add Tailscale APT repository
  ansible.builtin.apt_repository:
    repo: "deb https://pkgs.tailscale.com/stable/debian {{ ansible_distribution_release }} main"
    state: present
  become: true

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  become: true

- name: Check Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Remind to authenticate Tailscale
  ansible.builtin.debug:
    msg: "Run: sudo tailscale up"
  when: tailscale_status.rc != 0

- name: Get Tailscale IP
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip
  changed_when: false
  when: tailscale_status.rc == 0

- name: Save Tailscale IP to vars
  ansible.builtin.lineinfile:
    path: "{{ playbook_dir }}/vars/main.yml"
    regexp: '^tailscale_ip:'
    line: "tailscale_ip: {{ tailscale_ip.stdout }}"
  when: tailscale_status.rc == 0

- name: Show Tailscale IP
  ansible.builtin.debug:
    msg: "Tailscale IP: {{ tailscale_ip.stdout }}"
  when: tailscale_status.rc == 0
