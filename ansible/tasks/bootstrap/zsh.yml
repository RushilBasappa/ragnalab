---
# Zsh + Zinit + Starship prompt setup

- name: Install zsh
  ansible.builtin.apt:
    name: zsh
    state: present
  become: true

- name: Set zsh as default shell
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: /usr/bin/zsh
  become: true

- name: Install Zinit
  ansible.builtin.git:
    repo: https://github.com/zdharma-continuum/zinit.git
    dest: "{{ ansible_env.HOME }}/.local/share/zinit/zinit.git"
    depth: 1

- name: Check if Starship is installed
  ansible.builtin.stat:
    path: /usr/local/bin/starship
  register: starship_bin

- name: Install Starship
  ansible.builtin.shell: curl -sS https://starship.rs/install.sh | sh -s -- -y
  when: not starship_bin.stat.exists
  become: true

- name: Configure zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    create: true
    mode: "0644"
    marker: "# {mark} ragnalab-managed"
    block: |
      # Zinit
      source "${HOME}/.local/share/zinit/zinit.git/zinit.zsh"

      # Plugins
      zinit light zsh-users/zsh-autosuggestions
      zinit light zsh-users/zsh-history-substring-search

      # Bind up/down arrows to history substring search
      bindkey '^[[A' history-substring-search-up
      bindkey '^[[B' history-substring-search-down

      # History settings
      HISTSIZE=10000
      SAVEHIST=10000
      HISTFILE=~/.zsh_history
      setopt SHARE_HISTORY
      setopt HIST_IGNORE_DUPS

      # Prompt
      eval "$(starship init zsh)"
