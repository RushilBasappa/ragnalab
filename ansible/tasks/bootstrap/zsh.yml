---
# Zsh + Starship prompt setup

- name: Install zsh and autosuggestions
  ansible.builtin.apt:
    name:
      - zsh
      - zsh-autosuggestions
    state: present
  become: true

- name: Clone zsh-history-substring-search
  ansible.builtin.git:
    repo: https://github.com/zsh-users/zsh-history-substring-search.git
    dest: /usr/share/zsh-history-substring-search
    depth: 1
  become: true

- name: Set zsh as default shell
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: /usr/bin/zsh
  become: true

- name: Check if Starship is installed
  ansible.builtin.stat:
    path: /usr/local/bin/starship
  register: starship_bin

- name: Install Starship
  ansible.builtin.shell: curl -sS https://starship.rs/install.sh | sh -s -- -y
  when: not starship_bin.stat.exists
  become: true

- name: Configure zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    create: true
    mode: "0644"
    marker: "# {mark} ragnalab-managed"
    block: |
      # Plugins
      source /usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh
      source /usr/share/zsh-history-substring-search/zsh-history-substring-search.plugin.zsh

      # Bind up/down arrows to history substring search
      bindkey '^[[A' history-substring-search-up
      bindkey '^[[B' history-substring-search-down

      # History settings
      HISTSIZE=10000
      SAVEHIST=10000
      HISTFILE=~/.zsh_history
      setopt SHARE_HISTORY
      setopt HIST_IGNORE_DUPS

      # Prompt
      eval "$(starship init zsh)"
